### 持久化模式

- 当```SAVE```命令执行时，Redis服务会被阻塞，客户端发送的请求都会被阻塞。只有执行完SAVE命令，重新开始接受客户端请求之后，客户端发送的命令才会被执行。
-  BGSAVE 后台执行保存，fork一个子线程来处理RDB。
  - ```save time count``` 意味着在时间time之内修改过count次就会被调用bgsave命令
  - 执行save或者bgsave的时候，程序会检测过期键，如果存在过期键，则会忽略，不会 保存到rdb文件中
  - 在redis服务器启动时候，如果是主节点，未过期的键会被load到redis数据库，过期键则会被忽略；如果是从数据库，文件中保存的所有键都会被load入数据库，主从同步的时候，从数据库会被清空，从数据库load所有数据不会对业务有啥影响。
- BGREWRITEAOF  后台备份AOF文件

> RDB模式， RDB载入期间，会一直处于阻塞状态，知道载入工作完成为止。

- 完整得RDB文件包含如下部分

  <img src="assets/image-20200516133927543.png" alt="image-20200516133927543" style="zoom:50%;" />

- databases对象中保存得数据结构如下

  <img src="assets/image-20200516134626747.png" alt="image-20200516134626747" style="zoom:50%;" />

- 如下图保存了包含0号数据库和3号数据库得文件

  <img src="assets/image-20200516134930823.png" alt="image-20200516134930823" style="zoom:50%;" />

- hash类型得数据保存格式，size为2，键长度为1得字符串a，值长度为5的字符串apple

  <img src="assets/image-20200516141432445.png" alt="image-20200516141432445" style="zoom:50%;" />![image-20200516141541042](assets/image-20200516141541042.png)

  <img src="assets/image-20200516141602885.png" alt="image-20200516141602885" style="zoom:50%;" />

- 查看RDB文件内容：```od -c dump.rdb```
- 参考阅读文章：
  - Redis RDB文件格式
  - Redis RDB版本历史
  - 解密Redis持久化

> AOF模式  -- 有限判断是否开启，如果开启则使用此恢复。

- 通过保存Redis服务器所执行的写命令来记录数据库状态，直接将命令写入到AOF文件中

- 在执行写命令的时候，会将写内容保存在redisServer数据结构的```aof_buf```中

- ```write```函数执行时，并没有立即写入到文件中，而是写入到了磁盘缓冲区中，何时写入磁盘由操作系统决定。如果需要立即写入磁盘，则由系统提供的```fsync```和```fdatasync``` 两个同步函数，会强制让操作系统立即将缓冲区中的内容写入的磁盘。

- 刷磁盘函数```flushAppendOnlyFile```

- ![image-20200624232824145](assets/image-20200624232824145.png)

- ![image-20200624233258864](assets/image-20200624233258864.png)

- redis中save 参数保存数据结构

  ![image-20200624233913288](assets/image-20200624233913288.png)

-  从服务器不会主动删除过期键，所有的从服务器的过期键由主服务器控制发送删除命令

  - 当主服务器在删除一个过期键之后，会显示地向所有从服务器发送一个del命令，告知从服务器删除这个过期键
  - 从服务器不会删除过期键。
  - 从服务器只有在收到主服务器发送过来的del命令之后，才会删除过期键。

- 